!function(a){"use strict";if(a.Pulse)return void a.console.error("Pulse is already defined");var b,c=function(c){b=this,this.audioContext=this._getAudioContext(),this.buffer=null,this.renderedBuffer=null,this.significantPeaks=null,this.beat={ms:null,bpm:null},Object.defineProperty(this,"REQUEST_PROGRESS",{value:101,writable:!1}),Object.defineProperty(this,"REQUEST_LOAD",{value:102,writable:!1}),Object.defineProperty(this,"REQUEST_ERROR",{value:1102,writable:!1}),Object.defineProperty(this,"REQUEST_ABORT",{value:104,writable:!1}),Object.defineProperty(this,"WEB_AUDIO_API_NOT_SUPPORTED",{value:1001,writable:!1});var d,e,f=Object.getNotifier(this);Object.defineProperty(this,"state",{get:function(){return parseInt(d,10)},set:function(a){a!=d&&(f.notify({type:"update",name:"state",oldValue:a}),d=a)}}),Object.defineProperty(this,"options",{get:function(){return c||this.getDefaultOptions()},set:function(a){var b,d=this.getDefaultOptions();for(b in d)void 0===a[b]&&(a[b]=d[b]);c=a}}),this.options=c,Object.observe(this,function(c){for(e=0;e<c.length;e++)if("update"===c[e].type&&"state"===c[e].name&&c[e].lastValue!=b.state)switch(b.state){case b.READY:a.console.log("READY");break;case b.WEB_AUDIO_API_NOT_SUPPORTED:a.console.error("WEB_AUDIO_API_NOT_SUPPORTED");break;case b.REQUEST_PROGRESS:a.console.log("REQUEST_PROGRESS");break;case b.REQUEST_LOAD:a.console.log("REQUEST_LOAD");break;case b.REQUEST_ERROR:a.console.error("REQUEST_ERROR");break;case b.REQUEST_ABORT:a.console.error("REQUEST_ABORT");break;default:a.console.error("STATE NOT IMPLEMENTED")}})};c.prototype._getAudioContext=function(){try{return a.AudioContext=a.AudioContext||a.webkitAudioContext,new a.AudioContext}catch(b){return this.state=this.WEB_AUDIO_API_NOT_SUPPORTED,null}},c.prototype.getDefaultOptions=function(){return{onComplete:function(){},onRequestProgress:function(){},onRequestSuccess:function(){},onRequestAbort:function(){},onRequestError:function(){},convertToMilliseconds:!0,removeDuplicates:!0}},c.prototype.loadBufferFromURI=function(a){if(null===this.audioContext)return!1;var c=new XMLHttpRequest;return c.open("GET",a,!0),c.responseType="arraybuffer",c.addEventListener("progress",function(a){b._requestProgress(a,this)},!1),c.addEventListener("load",function(a){b._requestLoad(a,this)},!1),c.addEventListener("error",function(){b._requestError(event,this)},!1),c.addEventListener("abort",function(){b._requestAbort(event,this)},!1),c.send(null),!0},c.prototype._requestProgress=function(a,b){this.state=this.REQUEST_PROGRESS,this.options.onRequestProgress(this,b,a)},c.prototype._requestLoad=function(a,b){b.readyState===b.DONE?(this.buffer=b.response,this.state=this.REQUEST_LOAD,this.options.onRequestSuccess(this,b,a),this._process()):this._requestError(a,b,this.options)},c.prototype._requestError=function(a,b){this.state=this.REQUEST_ERROR,this.options.onRequestError(this,b,a)},c.prototype._requestAbort=function(a,b){this.state=this.REQUEST_ABORT,this.options.onRequestAbort(this,b,a)},c.prototype._process=function(){this.audioContext.decodeAudioData(this.buffer,this._processCallback,function(){b.state=b.DECODING_ERROR})},c.prototype._getOfflineContext=function(b){var c=new a.OfflineAudioContext(1,b.length,b.sampleRate),d=c.createBufferSource(),e=c.createBiquadFilter();return d.buffer=b,e.type="lowpass",d.connect(e),e.connect(c.destination),d.start(0),c},c.prototype._processCallback=function(a){var c=b._getOfflineContext(a);c.oncomplete=function(a){b.renderedBuffer=a.renderedBuffer,b.significantPeaks=b.getSignificantPeaks(a),b.beat=b.getBeat(b.significantPeaks),b.options.onComplete(a,b)},c.startRendering()},c.prototype._getChannelDataMinMax=function(a){var b,c=a.length,d=a[0],e=a[0];for(b=1;c>b;b++)d=Math.min(d,a[b]),e=Math.max(e,a[b]);return{min:d,max:e}},c.prototype.getSignificantPeaks=function(){for(var a,c,d=this.renderedBuffer.getChannelData(0),e=this._getChannelDataMinMax(d),f=230,g=Math.abs(e.min)+Math.abs(e.max),h=e.min+.9*g,i=e.min+.3*g,j=h,k=this.renderedBuffer.sampleRate*(f/1e3),l=[],m=parseInt(this.renderedBuffer.duration,10),n=d.length;j>=i&&l.length<=m;){for(c=0;n>c;c++)d[c]>j&&(l.push(c),c+=k);j-=.05}if(l.sort(function(a,b){return a-b}),b.options.convertToMilliseconds)for(a in l)l[a]=Math.floor(l[a]/this.renderedBuffer.sampleRate*1e3);return b.options.removeDuplicates&&(l=l.filter(function(a,b){return(!b||a>l[b-1])&&a>0})),l},c.prototype.getBeat=function(a){var b,c,d,e,f,g,h,i,j={},k=0,l=0,m=0,n=0,o=[],p=[],q=0;for(c=1;c<a.length;c++)for(d=0;c>d;d++)a[c]-a[d]>=230&&(void 0===j[a[c]-a[d]]&&(j[a[c]-a[d]]=0),j[a[c]-a[d]]++);for(c in j)k+=Math.pow(j[c],2),l++;e=Math.sqrt(k/l);for(c in j)j[c]>e&&(j[c]>m&&(m=j[c],n=parseInt(c,10)),b=Math.floor(c/500),void 0===o[b]&&o.push({max:0,ms:parseInt(c,10)}),void 0!==o[b]&&j[c]>o[b].max&&(o[b]={max:j[c],ms:parseInt(c,10)}));for(f=o.slice(0,3),c=0;c<f.length;c++){p.push(0);for(d in o)p[c]+=o[d].ms%f[c].ms}for(q=0,g=p[q],c=1;c<p.length;c++)g>p[c]&&(g=p[c],q=c);return h=Math.round(6e4/f[q].ms),i=f[q].ms,{ms:i,bpm:h}},c.prototype.getExtrapolatedPeaks=function(a,b,c){var d,e,f,g,h=[],i=[],j=[],k=2,l=[];for(d=0;d<b.length;d++)for(e=0;d>e;e++)b[d]-b[e]==c.ms&&(h.push(b[d]),h.push(b[e]));for(h.sort(function(a,b){return a-b}),h=h.filter(function(a,b){return(!b||a>h[b-1]+230)&&a>0}),d=0;d<h.length-1;d++)h[d]+c.ms<=h[d+1]+k&&h[d]+c.ms>=h[d+1]-k?i.push(d):(j.length<i.length&&(j=i),i=[]);if(j.length){for(f=h[j[0]];f>c.ms;)f-=c.ms;for(g=h[j.length-1];g<1e3*a.duration;)g+=c.ms;for(d=f;g>=d;d+=c.ms)l.push(d)}return l},a.Pulse=c}(window);